---
title: "Keystone Taxa"
author: "MD"
date: "'r format(Sys.time(), '%b %d, %Y')'"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(agricolae)
library(patchwork)
library(tidyverse)
library(readxl)
library(phyloseq)
```

# Read in data


```{r}
u.wild <- read.csv('data/network-data-unfert-wild.csv')
k.uwild <- u.wild %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)%>% 
  dplyr::select(Label) %>% 
  mutate(., Dom="Wild")

u.trad <- read.csv('data/network-data-unfert-trad.csv')
k.utrad <- u.trad %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)%>% 
  dplyr::select(Label) 

u.mod <- read.csv('data/network-data-unfert-mod.csv')
k.umod <- u.mod %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)
```

```{r}
f.wild <- read.csv('data/network-data-fert-wild.csv')
k.fwild <- f.wild %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)%>% 
  dplyr::select(Label) %>% 
  mutate(., Dom="Wild")

f.trad <- read.csv('data/network-data-fert-trad.csv')
k.ftrad <- f.trad %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)
  dplyr::select(Label) 

f.mod <- read.csv('data/network-data-fert-mod.csv')
k.fmod <- f.mod %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)
```

```{r}
wild <- read.csv('data/network-data-wild.csv')
k.wild <- wild %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)%>% 
  dplyr::select(Label) %>% 
  mutate(., Dom="Wild")

trad <- read.csv('data/network-data-trad.csv')
k.trad <- trad %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)

mod <- read.csv('data/network-data-mod.csv')
k.mod <- mod %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09)
```


```{r}
unfert <- read.csv('data/network-data-unfert-all.csv')
k.unfert<- unfert %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09) %>% 
  dplyr::select(Label) %>% 
  mutate(., Fert="Fert")

fert <- read.csv('data/network-data-fert-all.csv')
k.fert <- fert %>% 
  filter(., Degree > 6 & WeightedDegree > 6 & ClosenessCentrality > 0.14 & BetweennessCentrality < 0.05 & ClusteringCoefficient > 0.09) %>% 
  dplyr::select(Label) %>% 
  mutate(., Fert="Unfert")

k.all <- rbind(k.unfert,k.fert)
```

```{r}
kegg <- read_excel('data/EMU_database.GIBBs.KO.PICRUST2.xlsx', sheet='EMU_database.GIBBs.PICRUSt2', range='B9:BE17565')
kegg <- kegg %>%
  mutate_if(is.numeric, replace_na, replace=0)

P.rel <- readRDS('data/P.rel.RDS')
P.keyu <- subset_taxa(P.rel, species == 'Fimbriiglobus ruber' |
                       species == 'Daejeonella oryzae' |
                       species == 'Planctomycetes bacterium Pan265' |
                       species == 'Acidothermus cellulolyticus' |
                       species == 'Polyangium fumosum')

P.keyf <- subset_taxa(P.rel, species == 'Sandaracinus amylolyticus' |
                       species == 'Peribacillus muralis')

```

```{r}


d <- psmelt(P.keyu) %>% 
  filter(., Fertilization == 'Unfertilized')

par(mfrow=c(2,2))
mod <- d %>% 
  lm(sqrt(Abundance) ~ Domestication, data = .)
plot(mod)
aov.mod <- aov(mod)
summary(aov.mod)
 
t<- HSD.test(mod, "Domestication");t



sum.do <- summarize(group_by(d, Domestication),
                   n=n(),
                   mean=mean(sqrt(Abundance)),
                   sd=sd(sqrt(Abundance)),
                   se=sd/sqrt(n))


pu <- ggplot(sum.do, aes(x=Domestication,y=mean))+
  geom_col(position='dodge',fill='#A6CEE3')+
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),position=position_dodge(0.9), width = .25)+
  labs(y="Keystone Taxa Relative Abundance (Square-Root-Transformed)")+
  theme(axis.text.x=element_text(size=14, colour = "black", family='Palatino Linotype' ), 
        axis.text.y=element_text(size=14, colour = "black",family='Palatino Linotype' ),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.key = element_blank(),
        legend.text = element_text(size = 24),
        strip.text.y = element_text(size=8, face="bold"), 
        legend.title = element_blank(),
        legend.position = 'none',
        strip.text = element_blank(),
        strip.background = element_blank(),
       axis.title.x = element_blank());pu
```


```{r}

d <- psmelt(P.keyf) %>% 
  filter(., Fertilization == 'Fertilized')

par(mfrow=c(2,2))
mod <- d %>% 
  lm(sqrt(Abundance) ~ Domestication, data = .)
plot(mod)
aov.mod <- aov(mod)
summary(aov.mod)
 
t<- HSD.test(mod, "Domestication");t



sum.do <- summarize(group_by(d, Domestication),
                   n=n(),
                   mean=mean(sqrt(Abundance)),
                   sd=sd(sqrt(Abundance)),
                   se=sd/sqrt(n))


pf <- ggplot(sum.do, aes(x=Domestication,y=mean))+
  geom_col(position='dodge',fill='#1F78B4')+
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),position=position_dodge(0.9), width = .25)+
  labs(y="Keystone Taxa Relative Abundance (Square-Root-Transformed)")+
  theme(axis.text.x=element_text(size=14, colour = "black", family='Palatino Linotype' ), 
        axis.text.y=element_text(size=14, colour = "black",family='Palatino Linotype' ),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.key = element_blank(),
        legend.text = element_text(size = 24),
        strip.text.y = element_text(size=8, face="bold"), 
        legend.title = element_blank(),
        legend.position = 'none',
        strip.text = element_blank(),
        strip.background = element_blank(),
       axis.title.x = element_blank()); pf
```


```{r}
p <- pu/pf;p
```


```{r}
P40 <- createPalette(15, c("#FF0000", "#00FF00", "#0000FF"), range = c(30, 80))
swatch(P40)
P40 <- sortByHue(P40)
P40 <- as.vector(t(matrix(P40, ncol=4)))
swatch(P40)
names(P40) <- NULL

k <- read.csv('data/keystone.csv')


p<-ggplot(k, aes(x=Species, y=(Function), color=GeneName)) + 
  geom_point(size = 7) + 
  scale_color_manual(values = P40)+
  geom_hline(yintercept = 1.5, color='gray50')+
  geom_hline(yintercept = 2.5, color='gray50')+
  geom_hline(yintercept = 3.5, color='gray50')+
  geom_hline(yintercept = 4.5, color='gray50')+
  geom_hline(yintercept = 5.5, color='gray50')+
  geom_hline(yintercept = 6.5, color='gray50')+
  geom_hline(yintercept = 7.5, color='gray50')+
  geom_hline(yintercept = 8.5, color='gray50')+
  geom_hline(yintercept = 9.5, color='gray50')+
  geom_hline(yintercept = 10.5, color='gray50')+
  geom_hline(yintercept = 11.5, color='gray50')+
  theme(axis.text.x = element_text(family = 'serif', color='black'),
        axis.text.y = element_text( color='black',family = 'serif'),
        legend.text = element_text( color='black',family='serif'),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.key = element_blank(),
        legend.title = element_blank(),
        strip.background = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank());p
```

